{% extends "base.html" %}

{% block title%}Carto VL Map Page{% endblock %}


{% block content %}

    <script src="https://libs.cartocdn.com/carto-vl/v1.2.4/carto-vl.min.js"></script>
    <!-- Load Mapbox GL -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css" rel="stylesheet">
	<style>
	  #map {
		width: 80%;
        height: 80%;
        position: absolute;
	  }
	</style>

    <!-- Your map will go here -->
	<dv class="container">
	  <div id="map"></div>
    </div> 

<script>
  const config = {{ config | safe }}
  console.log("CONF", config)
  const map = new mapboxgl.Map(config.map)

  carto.setDefaultAuth({
    username: 'paulwalker-datopian',
    apiKey: 'Mef_QoqGyQRspq9AumGvbg'
  })
  
  config.layers.forEach(l => {
    console.log(l)
    const s = carto.expressions
    const source = new carto.source.Dataset(l.source)
    // works - js syntax
    /* const viz = new carto.Viz({
      color: s.ramp(s.buckets(s.prop('nb_victimes_total'), [0, 1, 2, 3, 4, 5, 10, 100]), s.palettes.PRISM)
    }) */

    // works - string syntax
    /* const viz = new carto.Viz(`
      color: ramp(buckets(prop($nb_victimes_total), [1, 1, 2, 3, 4, 5, 10, 100]), Prism)
    `) */
    console.log(l.viz)
    const viz = new carto.Viz(l.viz)

    const layer = new carto.Layer('layer', source, viz)
    layer.addTo(map)
  })
</script>

{% endblock %}

<!-- wax footer -->
{% block footer %}{% endblock %}
